#!/usr/bin/env bash
set -e

# ------- 可调 -------
NODE_IMG=node:16-alpine
OLD_VER=4.2.0
NEW_VER=4.4.3
DEPTHS=(800 1600 3200 6400 12800 25600 51200 102400)
MEM=1g          # ← 给每次 docker run 1 GiB RAM
# -------------------

echo "Building baseline images..."
docker build -t css-old-base --build-arg NODE_IMAGE=$NODE_IMG \
  --build-arg CSSTOOLS_VER=$OLD_VER  -q .
docker build -t css-new-base --build-arg NODE_IMAGE=$NODE_IMG \
  --build-arg CSSTOOLS_VER=$NEW_VER  -q .

echo -e "\nDepth\told(ms)\tnew(ms)"
results=""

for d in "${DEPTHS[@]}"; do
  old=$(docker run --rm --memory=$MEM --memory-swap=$MEM \
        -e DEPTH=$d css-old-base || echo OOM)
  new=$(docker run --rm --memory=$MEM --memory-swap=$MEM \
        -e DEPTH=$d css-new-base || echo OOM)
  printf "%d\t%s\t%s\n" "$d" "$old" "$new"
  results+="$d $old $new\n"
done

# ---------- 计算斜率 ----------
echo -e "$results" |
awk '
  $2 ~ /^[0-9.]+$/ && $3 ~ /^[0-9.]+$/ {
    ld=log($1); lo=log($2); ln=log($3);
    sd+=ld; so+=lo; sn+=ln; sdd+=ld*ld;
    sod+=ld*lo; snd+=ld*ln; n++
  }
  END{
    if(n<2){print "\n<2  个数据点 —— 仍被 OOM。请再调高 --memory>"; exit 1}
    k_old=(n*sod-sd*so)/(n*sdd-sd*sd);
    k_new=(n*snd-sd*sn)/(n*sdd-sd*sd);
    printf "\n≈log‑log slope k  old≈%.2f  new≈%.2f\n", k_old, k_new
  }'
