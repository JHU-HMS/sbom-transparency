const express = require('express');
const Plotly  = require('plotly.js/dist/plotly'); // 2.24.2 → vulnerable

const app = express();
app.use(express.json());

/**
 * 触发点：把任意 JSON 整体送进 Lib.expandObjectPaths，
 * 其中如果含有 "__proto__" 路径，就会写进 Object.prototype。
 */
app.post('/pollute', (req, res) => {
  try {
    Plotly.Lib.expandObjectPaths(req.body);   // ★ 漏洞函数
    res.send('expandObjectPaths finished');
  } catch (e) {
    console.error(e);
    res.status(500).send(e.toString());
  }
});

/** 验证污染是否成功 */
app.get('/check', (_, res) => {
  res.send(`polluted = ${({}).pwned}`);
});

app.listen(3000, () => console.log('Vulnerable Plotly helper listening on 3000'));
